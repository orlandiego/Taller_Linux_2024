---
- name: Configuro servidor base de datos en ubuntu
  hosts: database
  become: true
  user: sysadmin
  vars:
    db_root_password: "dbadmin"
    db_user: "sysadmin"
    db_user_password: "dbadmin"
    db_name: "DatabaseTSL"

  tasks:

  - name: UFW instalado
    ansible.builtin.apt:
      name: ufw
      state: present

  - name: Permitir puerto 22 en ufw
    community.general.ufw:
      rule: allow
      name: OpenSSH

  - name: Defino politicas de tr치fico entrante
    community.general.ufw:
      policy: allow
      direction: outgoing
      state: enabled

  - name: Defino politicas de tr치fico entrante
    community.general.ufw:
      policy: deny
      direction: incoming
      state: enabled

  - name: servicio UFW levantado y activo
    ansible.builtin.systemd_service:
      name: ufw
      state: started
      enabled: true

## Instalaci칩n de base de datos
  - name: MariaDB instalado
    ansible.builtin.apt:
      name: mariadb-server
      state: present
      update-cache: true

  - name: Cambiar la configuracion para escuchar en todas las interfaces
    ansible.builtin.lineinfile:
      path: /etc/mysql/mariadb.conf.d/50-server.cnf
      regexp: '^bind-address'
      line: 'bind-address         = 0.0.0.0'
    notify: Restart mariadb

# Iniciar y habilitar el servicio de MariaDB
  - name: Servidor Mariadb levantado
    ansible.builtin.systemd_service: 
      name: mariadb
      state: started
      enabled: true

# Me aseguro que exista un usuario root
  - name: Asegurar MariaDB con mysql_secure_installation
    expect:
      command: mysql_secure_installation
      responses:
        'Enter current password for root (enter for none):': ''
        'Set root password? \[Y/n\]': 'Y'
        'New password:': "{{ db_root_password }}"
        'Re-enter new password:': "{{ db_root_password }}"
        'Remove anonymous users? \[Y/n\]': 'Y'
        'Disallow root login remotely? \[Y/n\]': 'Y'
        'Remove test database and access to it? \[Y/n\]': 'Y'
        'Reload privilege tables now? \[Y/n\]': 'Y'
    no_log: true

  - name: Pausa para asegurar que los cambios tomen efecto
    pause:
      seconds: 5

  - name: Habilitamos en ufw la conexi칩n a mariadb
    community.general.ufw:
      rule: allow
      port: '3306'
      protocol: tcp
      direction: in

  - name: Crear base de datos
    community.mysql.mysql_db:
      name: "{{ db_name }}"
      state: present

  - name: Crear usuario de base de datos
    community.mysql.mysql_user:
      name: "{{ db_user }}"
      password: "{{ db_user_password }}"
      priv: "{{ db_name }}.*:ALL"
      host: "%"
      state: present

  handlers:

  - name: Restart mariadb
    ansible.builtin.systemd_service: 
      name: mariadb
      state: restarted